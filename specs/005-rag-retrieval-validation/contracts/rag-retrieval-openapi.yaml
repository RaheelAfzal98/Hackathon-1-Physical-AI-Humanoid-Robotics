openapi: 3.0.3
info:
  title: RAG Retrieval API
  description: API for retrieving semantically relevant content chunks from the RAG system
  version: 1.0.0
servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.example.com
    description: Production server

paths:
  /rag/retrieve:
    post:
      summary: Retrieve semantically relevant content chunks
      description: Submit a natural-language query and retrieve the most relevant content chunks from the vector database
      operationId: retrieve_content
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Successful retrieval of content chunks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetrievalResponse'
        '400':
          description: Bad request due to invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Unprocessable entity due to validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /rag/validate-pipeline:
    get:
      summary: Validate end-to-end retrieval pipeline
      description: Test the complete retrieval pipeline from query to results to ensure data integrity
      operationId: validate_pipeline
      responses:
        '200':
          description: Pipeline validation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PipelineValidationResponse'
        '500':
          description: Internal server error during validation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    QueryRequest:
      type: object
      properties:
        text:
          type: string
          description: Natural language query text
          example: "How do humanoid robots achieve bipedal locomotion?"
        top_k:
          type: integer
          description: Number of results to retrieve
          minimum: 1
          maximum: 20
          default: 5
          example: 5
        similarity_threshold:
          type: number
          description: Minimum similarity score for inclusion
          minimum: 0.0
          maximum: 1.0
          default: 0.5
          example: 0.7
        filters:
          type: object
          description: Optional filters for metadata-based query refinement
          additionalProperties: true
          example:
            document_id: "ch04-humanoid-locomotion"
      required:
        - text

    RetrievalResponse:
      type: object
      properties:
        query_text:
          type: string
          description: The original query text submitted by the user
          example: "How do humanoid robots achieve bipedal locomotion?"
        results:
          type: array
          description: Ranked list of relevant content chunks
          items:
            $ref: '#/components/schemas/RankedChunk'
        total_chunks_processed:
          type: integer
          description: Total number of chunks considered during retrieval
          example: 125
        search_time_ms:
          type: number
          description: Time taken to perform the retrieval operation
          example: 45.2
        retrieval_parameters:
          $ref: '#/components/schemas/RetrievalParameters'

    RankedChunk:
      type: object
      properties:
        chunk:
          $ref: '#/components/schemas/ContentChunk'
        similarity_score:
          type: number
          description: Cosine similarity score between query and chunk
          minimum: 0.0
          maximum: 1.0
          example: 0.85
        rank:
          type: integer
          description: Position in the ranked results (0-indexed)
          example: 0

    ContentChunk:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the chunk
          example: "ch04-001"
        content:
          type: string
          description: The actual text content of the chunk
          example: "Humanoid robots achieve bipedal locomotion through a combination of advanced control algorithms including ZMP (Zero Moment Point) control and whole-body motion controllers..."
        metadata:
          type: object
          description: Metadata about the content chunk
          properties:
            source_url:
              type: string
              description: Original URL or file path where the content originated
              example: "/chapters/ch04-humanoid-locomotion.md"
            page_title:
              type: string
              description: Title of the page/chapter containing the content
              example: "Humanoid Locomotion"
            section:
              type: string
              description: Section or subsection header
              example: "Control Systems"
            chunk_index:
              type: integer
              description: Sequential position of this chunk in the original content
              example: 1
            document_id:
              type: string
              description: Identifier for the parent document
              example: "ch04-humanoid-locomotion"
          required:
            - source_url
            - page_title
            - document_id
        created_at:
          type: string
          format: date-time
          description: Timestamp when the chunk was created
          example: "2025-12-18T10:00:00Z"

    RetrievalParameters:
      type: object
      properties:
        top_k:
          type: integer
          description: Maximum number of results to return
          example: 5
        similarity_threshold:
          type: number
          description: Minimum similarity score for inclusion
          example: 0.7
        collection_name:
          type: string
          description: Name of the vector database collection to search
          example: "book_embeddings"
        filters:
          type: object
          description: Filters applied during search
          additionalProperties: true

    PipelineValidationResponse:
      type: object
      properties:
        status:
          type: string
          description: Overall validation status
          enum: [success, failure]
          example: "success"
        message:
          type: string
          description: Human-readable validation result
          example: "Pipeline validation successful"
        results:
          type: array
          description: Detailed validation results
          items:
            type: object
            properties:
              test_name:
                type: string
                description: Name of the validation test
                example: "connectivity_test"
              status:
                type: string
                description: Individual test result
                enum: [pass, fail]
                example: "pass"
              details:
                type: string
                description: Additional information about the test
                example: "Successfully connected to Qdrant Cloud"

    ErrorResponse:
      type: object
      properties:
        error_code:
          type: string
          description: Standardized error code
          example: "INTERNAL_ERROR"
        message:
          type: string
          description: Human-readable error description
          example: "An unexpected error occurred during processing"
        timestamp:
          type: string
          format: date-time
          description: When the error occurred
          example: "2025-12-18T10:00:00Z"

    ValidationError:
      type: object
      properties:
        error_code:
          type: string
          description: Standardized error code
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Human-readable error description
          example: "Request validation failed"
        details:
          type: object
          description: Field-specific validation errors
          additionalProperties:
            type: array
            items:
              type: string
          example:
            text: ["must not be empty"]
            top_k: ["must be between 1 and 20"]
        timestamp:
          type: string
          format: date-time
          description: When the error occurred
          example: "2025-12-18T10:00:00Z"