# Data Models: RAG Ingestion Pipeline

## Overview
This document defines the data models for the RAG ingestion pipeline that extracts book content from deployed website URLs, generates embeddings using Cohere, and stores them in Qdrant Cloud for RAG-based retrieval.

## Key Entities

### Content Chunk
Represents a segment of cleaned text from the source website, with associated semantic embedding, source URL, and timestamp

#### Fields
- `id` (string): Unique identifier for the chunk (SHA256 hash of URL + content snippet + chunk index)
- `text_content` (string): The cleaned text content of the chunk
- `source_url` (string): The URL from which this content was extracted
- `created_at` (datetime): Timestamp when this chunk was created
- `updated_at` (datetime): Timestamp when this chunk was last updated
- `chunk_index` (integer): Position of this chunk within the original document
- `total_chunks` (integer): Total number of chunks from the original document
- `hash` (string): Hash of the content for change detection

#### Relationships
- Belongs to: Source Metadata

#### Validations
- `text_content` must not be empty
- `source_url` must be a valid URL format
- `chunk_index` must be >= 0
- `total_chunks` must be > 0
- `total_chunks` >= `chunk_index`

#### State Transitions
- N/A (immutable once created)

### Embedding Vector
High-dimensional vector representation of text content generated by Cohere models, used for similarity searches

#### Fields
- `vector_id` (string): Same as Content Chunk `id` (for consistency)
- `embedding` (array[float32]): The actual embedding vector (e.g., 1024 dimensions for Cohere models)
- `dimensionality` (integer): Number of dimensions in the embedding
- `model_version` (string): Version of the embedding model used (e.g., embed-multilingual-v3.0)

#### Relationships
- References: Content Chunk
- Part of: Qdrant Collection

#### Validations
- `embedding` must have consistent dimensionality
- `dimensionality` must match the model requirements
- `model_version` must be a valid Cohere model version

#### State Transitions
- N/A (immutable once created)

### Source Metadata
Information about the original content including URL, extraction timestamp, and processing parameters

#### Fields
- `source_url` (string): The URL of the source content
- `title` (string, nullable): Title of the content as it appears on the page
- `extracted_at` (datetime): When the content was extracted
- `processed_at` (datetime): When the content was processed and chunked
- `page_hash` (string): Hash of the entire page content for change detection
- `processing_params` (JSON): Parameters used during processing (chunk_size, overlap, etc.)

#### Relationships
- Contains: Multiple Content Chunks
- Generated: Embedding Vectors

#### Validations
- `source_url` must be a valid URL
- `extracted_at` must be before or equal to `processed_at`
- `processing_params` must be valid JSON

#### State Transitions
- N/A (immutable once created)

### Pipeline Configuration
Settings controlling text cleaning rules, chunking parameters, embedding models, and storage options

#### Fields
- `chunk_size` (integer): Maximum size of text chunks (default: 512 tokens)
- `chunk_overlap` (integer): Overlap between consecutive chunks (default: 50 tokens)
- `embedding_model` (string): Cohere model to use for embeddings (default: embed-multilingual-v3.0)
- `collection_name` (string): Name of Qdrant collection to store vectors
- `batch_size` (integer): Number of chunks to process in each batch (default: 10)
- `max_retries` (integer): Maximum number of retries for failed operations (default: 3)
- `delay_base` (float): Base delay for exponential backoff (default: 1.0)
- `timeout` (integer): Timeout for API requests in seconds (default: 30)
- `enable_change_detection` (boolean): Whether to check for content changes before ingestion (default: true)

#### Relationships
- Used by: All pipeline services

#### Validations
- `chunk_size` must be > 0 and <= 2048
- `chunk_overlap` must be >= 0 and < `chunk_size`
- `batch_size` must be > 0 and <= 50
- `max_retries` must be >= 0 and <= 10
- `timeout` must be > 0 and <= 300

#### State Transitions
- N/A (loaded at pipeline startup)

## Qdrant Collection Schema

### Payload Structure
The payload for each vector in Qdrant will contain:
```
{
  "id": "sha256 hash of URL+content+index",
  "text_content": "the actual text content of the chunk",
  "source_url": "the URL from which the content was extracted",
  "title": "optional title of the content",
  "created_at": "ISO datetime string",
  "updated_at": "ISO datetime string",
  "chunk_index": integer,
  "total_chunks": integer,
  "hash": "content hash for change detection",
  "metadata": {
    "source_domain": "extracted domain from source_url",
    "word_count": integer,
    "language": "detected language"
  }
}
```

### Vector Configuration
- Size: Determined by Cohere model (e.g., 1024 for embed-multilingual-v3.0)
- Distance: Cosine (recommended for semantic embeddings)
- HNSW config: Default Qdrant settings with M=16, ef_construct=100
- Quantization: Optional scalar quantization to reduce storage (configurable)

### Indexing Strategy
- Point ID: The same SHA256 hash used for Content Chunk ID
- Indexed fields: source_url, created_at, chunk_index
- Full-text search: Implemented through payload filtering on text_content